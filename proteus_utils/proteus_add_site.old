#!/bin/bash

siteurl=""
localip="127.1.1.111"
ip_ending=111
userspecifiedip=false
helparg=false
filecontents=$(</etc/hosts)
noforward=false

user=$(whoami)

while [ $# -gt 0 ]
do
	case "$1" in
		-url)	siteurl="$2";	shift;;
		-ip)	localip="$2";	shift;	userspecifiedip=true;;
		-h)	helparg=true;;
		-noforward)	noforward=true;;
	esac
	shift
done

if [ "$helparg" = true ]
then
	echo "**************************************"
	echo "* This will add a specified site URL into the local hosts file, then set up port forwarding for the Proteus server."
	echo "* ARGS: "
	echo "* -url [site url] required argument for specifying the site url to add"
	echo "* -ip [ip] optional argument to explicitly define an ip to associate with the site.  Auto-assigns otherwise"
	echo "* -noforward optional argument to turn off the port forwarding section of this script"
	echo "**************************************"
	exit
fi

if [ "$user" != "root" ]
then
	echo "==== Permission denied: please re-run this script as sudo. ===="
	exit
fi

if [ -z "$siteurl" ]
then
	echo "==== Site url is empty.  Please rerun with the -url argument specified. ===="
	exit
fi

echo "==== Adding new site into hosts file. ===="

if [[ "$filecontents" == *"$localip"* ]]
then
	if [ "$userspecifiedip" = true ]
	then
		echo "==== Specified IP: $localip is already listed within hosts file, will auto-generate IP instead. ===="
	fi
	while [[ "$filecontents" == *"$localip"* ]]
	do
		localip="127.1.1.$ip_ending"
		ip_ending=$((ip_ending+1))
	done
fi


if [[ "$filecontents" == *"$siteurl"* ]]
then
	echo "==== Site URL: '$siteurl' is already within hosts file, please rerun with a unique site url. ===="
	exit
fi

echo "$localip	$siteurl" >> /etc/hosts

echo "==== Site added to hosts file with ip $localip and url '$siteurl'. ===="

echo "==== Setting up port forwarding. ===="
echo "==== If you did not wish to set up port forwarding use the -noforward argument next time. ===="

iptables -t nat -A OUTPUT -d "$localip" -p tcp --dport 80 -j REDIRECT --to-port 8080

echo "==== Saving iptables configuration to /etc/iptables.conf ===="

iptables-save > /etc/iptables.conf

iptables-restore < /etc/iptables.conf

echo "==== Your site is ready to be created within Proteus.  The URL is: '$siteurl'. ===="

