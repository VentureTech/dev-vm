#!/bin/bash

webfolder=""
libraryfolder=""
defaultlocal="/opt/maps"
basehost="http://localhost:8080/_files"
hostname=""
sitemappedpath=""
helparg=false

user=$(whoami)

while [ $# -gt 0 ]
do
	case "$1" in
		-web)	webfolder="$2";	shift;;
		-lib)		libraryfolder="$2";	shift;;
		-host)	hostname="$2";	shift;;
		-base)	basehost="$2";	shift;;
		-local)	defaultlocal="$2";	shift;;
		-h)	helparg=true;;
	esac
	shift
done

if [ "$helparg" = true ]
then
	echo "**************************************"
	echo "* This will map the WebDAV folders for a specified site onto your local drive."
	echo "* ARGS: "
	echo "* -host [hostname] required argument for specifying the site's hostname for mapping (must not end with '/')"
	echo "* -web [folder] optional argument to explicitly define a folder within the Web directory for mapping (must not end with '/')"
	echo "* -lib [folder] optional argument to explicitly define a folder within the Libraries directory for mapping (must not end with '/')"
	echo "* -base [hostname] optional argument to explicitly define a base hostname for mapping (must not end with '/')"
	echo "* -local [folder] option argument to explicitly define a local base folder for mapping (must not end with '/')"
	echo "**************************************"
	exit
fi

map_it () {
	local hostdir=""
	local localdir=""
	
	while [ $# -gt 0 ]
	do
		case "$1" in
			-host)	hostdir="$2";	shift;;
			-local)		localdir="$2";	shift;;
		esac
		shift
	done
	
	sh -c 'echo "$hostdir $localdir davfs noauto,user 0 0" > /etc/fstab'
}

if [ "$user" != "root" ]
then
	echo "==== Permission denied: please re-run this script as sudo. ===="
	exit
fi

if [ -z "$hostname" ]
then
	echo "==== Host name is empty.  Please rerun with the -host argument specified. ===="
	exit
fi

sitemappedpath="$defaultlocal/$hostname"

if [ -z "$webfolder" ]
then
	echo "==== Mapping site Web folder to: $sitemappedpath/Web ===="
	mkdir -p "$sitemappedpath/Web"
	map_it -host "$basehost/Other Sites/$hostname/Web" -local "$sitemappedpath/Web"
else
	echo "==== Mapping site $webfolder folder to: $sitemappedpath/Web/$webfolder ===="
	mkdir -p "$sitemappedpath/Web/$webfolder"
	map_it -host "$basehost/Other Sites/$hostname/Web/$webfolder" -local "$sitemappedpath/Web/$webfolder"
fi

if [ -z "$libraryfolder" ]
then
	echo "==== Mapping global Libraries folder to: $defaultlocal/Libraries ===="
	mkdir -p "$defaultlocal/Libraries"
	map_it -host "$basehost/Libraries" -local "$defaultlocal/Libraries"
else
	echo "==== Mapping Libraries $libraryfolder folder to: $defaultlocal/Libraries/$libraryfolder ===="
	mkdir -p "$defaultlocal/Libraries/$libraryfolder"
	map_it -host "$basehost/Libraries/$libraryfolder" -local "$defaultlocal/Libraries/$libraryfolder"
fi

echo "==== Done ===="
